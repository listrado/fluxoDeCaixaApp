<%# app/views/entries/index.html.erb %>
<% require "ostruct" %>
<% rows = @rows || [] %>

<style>
  /* ================================
   * LAYOUT E TABELA
   * ================================ */
  .sheet-wrap { height: calc(100vh - 140px); display:flex; flex-direction:column; gap:.5rem; }
  .sheet { border:1px solid #cbd5e1; border-radius:8px; overflow:hidden; }
  .sheet-scroller { overflow:auto; height:100%; }

  .sheet-table {
    width: auto;
    min-width: 960px;
    border-collapse:separate; border-spacing:0; table-layout:fixed; font-size:14px;
  }
  .sheet-table thead th {
    position:sticky; top:0; background:#f1f5f9; z-index:2; font-weight:600; text-align:left; padding:10px 8px;
    border-bottom:1px solid #cbd5e1; border-right:1px solid #e2e8f0;
  }
  .sheet-table thead th:last-child { border-right:none; }
  .sheet-table tbody td {
    padding:8px; border-top:1px solid #e2e8f0; border-right:1px solid #f1f5f9; background:#fff;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;
  }
  .sheet-table tbody td:last-child { border-right:none; }
  .sheet-table tbody tr:hover td { background:#f8fafc; }

  .text-end { text-align:right; } .text-center { text-align:center; } .fw-semibold { font-weight:600; }

  /* ===== TOOLBAR 4 COLUNAS ===== */
  .toolbar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    align-items: stretch;
  }
  .toolbar-grid .btn,
  .toolbar-grid .btn-xs {
    width: 100%;
    height: 42px;
    font-weight: 600;
  }

  /* ================================
   * REDIMENSIONAMENTO DE COLUNAS
   * ================================ */
  .resizable { position:relative; }
  .resizer {
    position:absolute; top:0; right:-3px; width:8px; height:100%;
    cursor:col-resize; user-select:none; -webkit-user-select:none;
    background:transparent;
  }
  .resizable::after { content:""; position:absolute; top:0; right:0; width:1px; height:100%; background:#e2e8f0; }
  .resizing th, .resizing td { cursor:col-resize !important; }
  .resizing .resizable::after { background:#3b82f6; }
  .resizer::before {
    content:""; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
    width:4px; height:22px;
    background: repeating-linear-gradient( to bottom, #93c5fd, #93c5fd 3px, transparent 3px, transparent 6px );
    border-radius:2px; opacity:.9;
  }

  /* ================================
   * BOTÕES
   * ================================ */
  .btn-xs { padding:4px 8px; border:1px solid #cbd5e1; background:#fff; border-radius:6px; font-size:12px; cursor:pointer; }
  .btn-xs:hover { background:#f8fafc; }
  .btn-primary { border-color:#bfdbfe; color:#1d4ed8; }
  .btn-secondary { color:#334155; }
  .btn { padding:8px 12px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; cursor:pointer; }
  .btn:hover { background:#f8fafc; }

  /* estado de loading */
  .btn.is-loading {
    background: #334155;       /* mais escuro */
    color: #fff;
    border-color: #334155;
    cursor: progress;
    animation: btn-blink 1s linear infinite;
  }

  /* spinner opcional no texto */
  .btn.is-loading::after {
    content: "";
    display: inline-block;
    vertical-align: -2px;
    width: 14px; height: 14px;
    margin-left: 8px;
    border: 2px solid currentColor;
    border-right-color: transparent; /* “buraco” do spinner */
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }

  /* desativado de verdade */
  .btn:disabled {
    pointer-events: none;
    opacity: 0.95; /* mantém visível, mas evita clique */
  }

  /* piscar levinho */
  @keyframes btn-blink {
    0%, 100% { filter: brightness(1); }
    50%      { filter: brightness(0.85); }
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* respeita preferências do usuário */
  @media (prefers-reduced-motion: reduce) {
    .btn.is-loading { animation: none; }
    .btn.is-loading::after { animation: none; }
  }

  /* variantes visuais */
  .btn-ghost { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn-ghost[disabled] { opacity:.6; cursor:not-allowed; }

  .icon-btn {
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border:1px solid #cbd5e1; border-radius:6px;
    background:#fff; cursor:pointer; text-decoration:none;
    transition:background .15s, border-color .15s;
    vertical-align:middle;
  }
  .icon-btn:hover { background:#f8fafc; border-color:#94a3b8; }
  .icon-btn svg { width:16px; height:16px; }
  .icon-btn.danger { border-color:#fecaca; }
  .icon-btn.danger:hover { background:#fef2f2; border-color:#fca5a5; }
  .icons-inline { display:flex; gap:6px; justify-content:center; }

  /* ================================
   * MODAL / OVERLAY
   * ================================ */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(15,23,42,.45);
    display: none; align-items: center; justify-content: center; z-index: 50;
  }
  .modal {
    background: #fff; border-radius: 12px; width: 100%; max-width: 620px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15); overflow: hidden;
  }
  .modal-header { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .modal-title { font-weight:600; }
  .modal-footer { padding: 12px 16px; border-top:1px solid #e2e8f0; display:flex; justify-content:flex-end; gap:8px; }
  .modal-body { padding: 16px 22px; }

  .type-switch { display:flex; gap:8px; flex-wrap:wrap; }
  .pill { padding:6px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:999px; font-size:13px; cursor:pointer; }
  .pill[data-type="income"].active  { border-color:#bbf7d0; background:#ecfccb; color:#166534; }
  .pill[data-type="expense"].active { border-color:#fecaca; background:#fee2e2; color:#7f1d1d; }

  /* ===== RESUMO (modal) ===== */
  .summary-card {
    background:#f8fafc;
    border:1px solid #e2e8f0;
    border-radius:10px;
    padding:16px;
  }
  .summary-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 0; border-bottom:1px solid #e2e8f0;
  }
  .summary-row:last-child { border-bottom:none; }
  .summary-title { font-weight:700; font-size:18px; margin-bottom:12px; }
  .text-danger { color:#dc2626; }
  .text-success { color:#16a34a; }

  /* ================================
   * FORM GRID
   * ================================ */
  .form-grid {
    display:grid;
    grid-template-columns: 140px 1fr;
    gap: 10px 14px; /* linhas x colunas */
    align-items:center;
  }
  .form-grid label { color:#334155; font-size:14px; }
  .form-grid input[type="text"],
  .form-grid input[type="date"],
  .form-grid input[type="number"],
  .form-grid textarea {
    width: 100%;
    box-sizing: border-box;
    padding:8px 10px;
    border:1px solid #cbd5e1;
    border-radius:8px;
    font-size:14px;
    line-height:1.2;
  }
  .form-grid input[readonly] {
    background: #f8fafc; color:#475569; cursor: not-allowed;
  }
  .w-100 { width:100%; }
</style>

<div class="sheet-wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h1 class="h5" style="margin:0;">Lançamentos</h1>
  </div>

  <div class="toolbar-grid" style="margin-bottom:10px;">
    <!-- 1) Iniciar Caixa (esquerda) -->
    <button id="open-startbox" class="btn btn-primary" type="button" title="Iniciar Caixa">Iniciar Caixa</button>

    <!-- 2) Slot futuro -->
    <button id="toolbar-slot-2" class="btn btn-ghost" type="button" disabled>Em breve</button>

    <!-- 3) Slot futuro -->
    <button id="toolbar-slot-3" class="btn btn-ghost" type="button" disabled>Em breve</button>

    <!-- 4) Lucro/Prejuízo (direita) -->
    <button id="open-summarybox" class="btn btn-secondary" type="button" title="Resumo Financeiro">Lucro/Prejuízo</button>
  </div>

  <%# ========== MODAL: NOVO LANÇAMENTO ========== %>
  <div id="startbox" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Novo lançamento</div>
        <div class="type-switch">
          <button type="button" class="pill active" data-type="income">Entrada</button>
          <button type="button" class="pill" data-type="expense" data-preset="">Saída</button>
          <button type="button" class="pill" data-type="expense" data-preset="investment">Investimento</button>
        </div>
      </div>
      <div class="modal-body">
        <%= form_with model: Entry.new, url: entries_path, local: true, html: { id: "quick-entry-form" } do |f| %>
          <%= f.hidden_field :kind, value: "income", id: "entry-kind" %>
          <input type="hidden" name="preset" id="entry-preset" value="">

          <div class="form-grid">
            <label for="entry_date">Data</label>
            <%= f.date_field :date, value: Date.current, class: "w-100" %>

            <label for="entry_category">Categoria</label>
            <%= f.text_field :category, placeholder: "Ex.: Vendas, Energia, Investimento…", class: "w-100", id: "entry-category" %>

            <label for="entry_description">Descrição</label>
            <%= f.text_field :description, placeholder: "Ex.: PIX cliente João / Fatura CPFL / Aporte XP", class: "w-100" %>

            <label for="entry_amount_mask">Valor</label>
            <input type="text" id="entry_amount_mask" class="w-100" inputmode="numeric" placeholder="0,00">
            <%= f.hidden_field :amount, id: "entry_amount_real" %>
          </div>

          <div class="modal-footer">
            <button type="button" id="close-startbox" class="btn">Cancelar</button>
            <%= f.submit "Salvar", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# ========== MODAL: EDITAR LANÇAMENTO (PATCH via fetch) ========== %>
  <div id="editbox" class="modal-backdrop" aria-hidden="true" style="display:none">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Editar lançamento</div></div>
      <div class="modal-body">
        <form id="edit-entry-form" action="#" data-turbo="false" onsubmit="return false;">
          <input type="hidden" id="edit-id">
          <input type="hidden" name="entry[amount]" id="edit-amount-real">

          <div class="form-grid">
            <label for="edit_date">Data</label>
            <input type="date" id="edit_date" name="entry[date]" class="w-100">

            <label for="edit_category">Categoria</label>
            <input type="text" id="edit_category" name="entry[category]" class="w-100" placeholder="Ex.: Vendas, Energia…">

            <label for="edit_description">Descrição</label>
            <input type="text" id="edit_description" name="entry[description]" class="w-100" placeholder="Descreva…">

            <label for="edit_amount_mask">Valor</label>
            <input type="text" id="edit_amount_mask" class="w-100" inputmode="numeric" placeholder="0,00">
          </div>

          <div class="modal-footer">
            <button type="button" id="close-editbox" class="btn">Cancelar</button>
            <button type="button" id="edit-save" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <%# ========== MODAL: LUCRO/PREJUÍZO ========== %>
  <div id="summarybox" class="modal-backdrop" aria-hidden="true" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Resumo Financeiro</div>
        <button type="button" id="close-summarybox" class="icon-btn" aria-label="Fechar">✕</button>
      </div>

      <div class="modal-body">
        <div class="summary-card">
          <div class="summary-row">
            <span>Total Entradas:</span>
            <span id="sum-income">R$ 0,00</span>
          </div>
          <div class="summary-row">
            <span>Total Saídas:</span>
            <span id="sum-expense">R$ 0,00</span>
          </div>
          <div class="summary-row">
            <span class="summary-title">Lucro/Prejuízo:</span>
            <span id="sum-profit" class="text-danger">R$ 0,00</span>
          </div>
          <div class="summary-row">
            <span>Total Investimento:</span>
            <span id="sum-invest">R$ 0,00</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="close-summarybox-2" class="btn">Fechar</button>
      </div>
    </div>
  </div>

  <%# ============= MODAL: Deletar ============= %>
  <div id="delbox" class="modal-backdrop" aria-hidden="true" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Confirmar exclusão</div>
        <button type="button" id="close-delbox" class="icon-btn" aria-label="Fechar">✕</button>
      </div>
      <div class="modal-body">
        <div class="summary-card">
          <div class="summary-title">Você tem certeza que deseja excluir este lançamento?</div>
          <div class="summary-row"><span>Data</span>        <span id="del-date">–</span></div>
          <div class="summary-row"><span>Categoria</span>   <span id="del-category">–</span></div>
          <div class="summary-row"><span>Descrição</span>   <span id="del-description">–</span></div>
          <div class="summary-row"><span>Valor</span>       <span id="del-amount">R$ 0,00</span></div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:space-between">
        <button type="button" id="del-no"  class="btn" style="border-color:#fecaca;color:#7f1d1d;">Não</button>
        <button type="button" id="del-yes" class="btn" style="border-color:#bbf7d0;color:#166534;">Sim</button>
      </div>
    </div>          <!-- fecha .modal -->
  </div>            <!-- ✅ fecha #delbox -->

  <%# ========== TABELA ========== %>
  <div class="sheet">
    <div class="sheet-scroller">
      <table class="sheet-table" id="entries-sheet">
        <colgroup>
          <col data-col="0" style="width: 140px;">
          <col data-col="1" style="width: 220px;">
          <col data-col="2" style="width: 600px;">
          <col data-col="3" style="width: 180px;">
          <col data-col="4" style="width: 180px;">
          <col data-col="5" style="width: 200px;">
          <col data-col="6" style="width: 180px;">
        </colgroup>
        <thead>
          <tr>
            <th class="resizable">Data <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable">Categoria <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable">Descrição <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable text-end">Entrada <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable text-end">Saída <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable text-end">Saldo <span class="resizer" title="Arraste para redimensionar"></span></th>
            <th class="resizable text-center">Ações <span class="resizer" title="Arraste para redimensionar"></span></th>
          </tr>
        </thead>
        <tbody>
          <% rows.each do |row| %>
            <% e = row[:entry] %>
            <tr>
              <td><%= e.date ? e.date.strftime("%d/%m/%Y") : "" %></td>
              <td><%= e.category %></td>
              <td><%= e.description %></td>
              <td class="text-end"><%= (row[:income].to_d > 0)  ? number_to_currency(row[:income],  unit: "R$ ", :delimiter => ".", :separator => ",") : "" %></td>
              <td class="text-end"><%= (row[:expense].to_d > 0) ? number_to_currency(row[:expense], unit: "R$ ", :delimiter => ".", :separator => ",") : "" %></td>
              <td class="text-end fw-semibold"><%= row[:balance].present? ? number_to_currency(row[:balance], unit: "R$ ", :delimiter => ".", :separator => ",") : "" %></td>
              <td class="text-center">
                <% if e&.id.present? %>
                  <span class="icons-inline">
                    <!-- EDITAR: abre modal -->
                    <button type="button"
                            class="icon-btn js-edit-entry"
                            title="Editar"
                            data-id="<%= e.id %>"
                            data-date="<%= e.date %>"
                            data-category="<%= h e.category %>"
                            data-description="<%= h e.description %>"
                            data-amount="<%= e.amount.present? ? ('%.2f' % e.amount) : '0.00' %>">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 20h9" />
                        <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                      </svg>
                    </button>

                    <!-- EXCLUIR -->
                    <button type="button"
                            class="icon-btn danger js-del-entry"
                            title="Excluir"
                            data-id="<%= e.id %>"
                            data-url="<%= entry_path(e) %>"
                            data-date="<%= e.date %>"
                            data-category="<%= h e.category %>"
                            data-description="<%= h e.description %>"
                            data-amount="<%= e.amount.present? ? ('%.2f' % e.amount) : '0.00' %>">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                        <path d="M10 11v6"></path>
                        <path d="M14 11v6"></path>
                        <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  /* =========================================================
   * UTIL: pegar CSRF do layout do Rails
   * ======================================================= */
  function getCsrf() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.content : null;
  }

  /* =========================================================
   * MÁSCARA DE DINHEIRO (centavos à direita)
   * - Digite apenas números; exibição com vírgula
   * - Hidden recebe ponto (ex: "10.00")
   * - __setFromDecimal("1234.56") preenche com o salvo
   * ======================================================= */
  function attachMoneyMask(inputEl, hiddenRealEl) {
    if (!inputEl) return;

    const render = () => {
      let digits = (inputEl.value || "").replace(/\D/g, "");
      if (digits === "") digits = "0";
      if (digits.length > 13) digits = digits.slice(0, 13); // limite de segurança

      const num = parseInt(digits, 10);
      const safeNum = isNaN(num) ? 0 : num;

      const br = (safeNum / 100)
        .toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      inputEl.value = br;

      if (hiddenRealEl) {
        hiddenRealEl.value = (safeNum / 100).toFixed(2);
      }
    };

    inputEl.addEventListener("keydown", (e) => {
      if (
        e.key === "Backspace" || e.key === "Delete" ||
        e.key === "ArrowLeft" || e.key === "ArrowRight" ||
        e.key === "Tab" || e.key === "Home" || e.key === "End" ||
        e.ctrlKey || e.metaKey
      ) return;
      if (!/^\d$/.test(e.key)) e.preventDefault();
    });

    inputEl.addEventListener("input", render);

    inputEl.value = "0,00";
    render();

    inputEl.__setFromDecimal = function (dec) {
      const asStr = String(dec ?? "0").replace(/[^\d]/g, "");
      inputEl.value = asStr; // deixa só dígitos; render converte para 0,00
      render();
    };
  }

  /* =========================================================
   * MODAL GENÉRICO (abrir/fechar)
   * ======================================================= */
  function openModal(backdropEl) {
    backdropEl.style.display = "flex";
    backdropEl.removeAttribute("aria-hidden");
  }
  function closeModal(backdropEl) {
    backdropEl.style.display = "none";
    backdropEl.setAttribute("aria-hidden", "true");
  }

  /* =========================================================
   * REDIMENSIONAR COLUNAS + SALVAR EM localStorage
   * ======================================================= */
  function enableResizableColumns(tableId, storageKey) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const cols = table.querySelectorAll('colgroup col');

    try {
      const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
      saved.forEach((w, idx) => { if (w) cols[idx].style.width = w; });
    } catch(e){}

    table.querySelectorAll('thead th.resizable').forEach((th, index) => {
      const handle = th.querySelector('.resizer');
      if (!handle) return;
      let startX, startWidth;

      handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        startX = e.pageX;
        const col = table.querySelector(`colgroup col[data-col="${index}"]`);
        startWidth = (col ? col.getBoundingClientRect().width : th.getBoundingClientRect().width);
        document.body.classList.add('resizing');

        const onMove = (ev) => {
          const delta = ev.pageX - startX;
          const newWidth = Math.max(80, Math.round(startWidth + delta));
          if (col) col.style.width = newWidth + 'px';
        };
        const onUp = () => {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          document.body.classList.remove('resizing');
          const widths = Array.from(cols).map(c => c.style.width || null);
          localStorage.setItem(storageKey, JSON.stringify(widths));
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    });
  }

  /* =========================================================
   * INICIALIZAÇÃO (IIFE)
   * ======================================================= */
  (function init() {

    // Desativar botão ao ser clicado
    function setBusyButton(btn, label = "Salvando...") {
      if (!btn) return;
      // guarda texto original para restaurar depois
      if (!btn.dataset.origText) btn.dataset.origText = btn.textContent;
      btn.textContent = label;
      btn.classList.add("is-loading");
      btn.setAttribute("aria-busy", "true");
      btn.setAttribute("disabled", "disabled"); // bloqueia clique
    }

    // Reativar o botão quando atualizado
    function clearBusyButton(btn) {
      if (!btn) return;
      btn.classList.remove("is-loading");
      btn.removeAttribute("aria-busy");
      btn.removeAttribute("disabled");
      if (btn.dataset.origText) btn.textContent = btn.dataset.origText;
    }

    // ----- Modal "Excluir"
    const delbox   = document.getElementById('delbox');
    const closeDel = document.getElementById('close-delbox');
    const btnNo    = document.getElementById('del-no');
    const btnYes   = document.getElementById('del-yes');

    const elDelDate = document.getElementById('del-date');
    const elDelCat  = document.getElementById('del-category');
    const elDelDesc = document.getElementById('del-description');
    const elDelAmt  = document.getElementById('del-amount');

    let delTargetId = null;
    let delTargetRow = null;

    function formatBRL(n) {
      return (Number(n) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    let delTargetUrl = null;

    // abrir modal ao clicar no ícone de lixeira
    document.querySelectorAll('.js-del-entry').forEach(btn => {
      btn.addEventListener('click', () => {
        delTargetUrl = btn.dataset.url || (btn.dataset.id ? `/entries/${btn.dataset.id}` : null);
        delTargetId  = btn.dataset.id;
        // guarda a <tr> para remover da DOM sem reload (se quiser)
        delTargetRow = btn.closest('tr');

        elDelDate.textContent = btn.dataset.date || '–';
        elDelCat.textContent  = btn.dataset.category || '–';
        elDelDesc.textContent = btn.dataset.description || '–';
        elDelAmt.textContent  = formatBRL(btn.dataset.amount || '0');

        openModal(delbox);
      });
    });

    if (closeDel) closeDel.addEventListener('click', () => closeModal(delbox));
    if (btnNo)    btnNo.addEventListener('click', () => closeModal(delbox));
    if (delbox)   delbox.addEventListener('click', (e) => { if (e.target === delbox) closeModal(delbox); });

    // confirmar exclusão (loading no botão "Sim")
    if (btnYes) {
      btnYes.addEventListener('click', async () => {
        if (!delTargetId) { closeModal(delbox); return; }

        setBusyButton(btnYes, 'Excluindo...');

        try {
          const resp = await fetch(`/entries/${delTargetId}`, {
            method: 'DELETE',
            headers: {
              'Accept': 'text/html,application/json',
              ...(getCsrf() ? {'X-CSRF-Token': getCsrf()} : {})
            }
          });

          if ([200, 204, 302].includes(resp.status)) {
            // opção A) remove a linha sem recarregar:
            if (delTargetRow) delTargetRow.remove();

            // opção B) recarrega lista (garante saldo recalculado no servidor):
            // window.location.assign('/entries');

            closeModal(delbox);
          } else {
            console.error('DELETE falhou:', await resp.text());
            alert('Falha ao excluir.');
          }
        } catch (err) {
          console.error(err);
          alert('Erro de rede ao excluir.');
        } finally {
          clearBusyButton(btnYes);
          delTargetId = null;
          delTargetRow = null;
        }
      });
    }

    // ----- Modal "Novo lançamento"
    const startbox = document.getElementById('startbox');
    const openStart = document.getElementById('open-startbox');
    const closeStart = document.getElementById('close-startbox');

    if (openStart && startbox) openStart.addEventListener('click', () => openModal(startbox));
    if (closeStart && startbox) closeStart.addEventListener('click', () => closeModal(startbox));
    if (startbox) startbox.addEventListener('click', (e) => { if (e.target === startbox) closeModal(startbox); });

    // Troca tipo/preset do "Novo"
    const kindInput   = document.getElementById('entry-kind');
    const presetInput = document.getElementById('entry-preset');
    const catInput    = document.getElementById('entry-category');
    if (catInput) catInput.removeAttribute('readonly');

    document.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const type = btn.getAttribute('data-type');           // income | expense
        const preset = btn.getAttribute('data-preset') || ""; // "" | "investment"
        if (kindInput) kindInput.value = type;
        if (presetInput) presetInput.value = preset;

        if (preset === 'investment') {
          if (catInput) {
            catInput.value = "Investimento";
            catInput.setAttribute('readonly', 'readonly');
          }
        } else {
          if (catInput) {
            catInput.removeAttribute('readonly');
            if (catInput.value === "Investimento") catInput.value = "";
          }
        }
      });
    });

    // Máscara: NOVO
    attachMoneyMask(
      document.getElementById("entry_amount_mask"),
      document.getElementById("entry_amount_real")
    );

    // Redimensionamento de colunas
    enableResizableColumns('entries-sheet', 'entries-sheet-colwidths');

    // ----- "Novo lançamento" (create)
    const formNew = document.getElementById('quick-entry-form');
    const btnNew  = formNew?.querySelector('input[type="submit"], button[type="submit"]');
    let savingNew = false;

    if (formNew && btnNew) {
      formNew.addEventListener('submit', (e) => {
        if (savingNew) { e.preventDefault(); return; }
        savingNew = true;

        // garante sync da máscara -> hidden antes de enviar
        const mask = document.getElementById('entry_amount_mask');
        const real = document.getElementById('entry_amount_real');
        if (mask && real) real.value = mask.value.replace(/\./g, '').replace(',', '.');

        setBusyButton(btnNew, 'Salvando...'); // fica escuro + piscando
        // não precisa limpar: a página vai navegar após o POST
      });
    }

    // ----- Modal "Lucro/Prejuízo"
    const summarybox   = document.getElementById('summarybox');
    const openSummary  = document.getElementById('open-summarybox');
    const closeSummary = document.getElementById('close-summarybox');
    const closeSummary2= document.getElementById('close-summarybox-2');

    // ===== Helpers BRL (substitua os stubs por isso)
    function parseBRL(str) {
      if (!str) return 0;
      // remove "R$", espaços normais e NBSP, pontos de milhar; troca vírgula por ponto
      const s = String(str)
        .replace(/R\$\s?/g, '')
        .replace(/[\s\u00A0]/g, '')
        .replace(/\./g, '')
        .replace(',', '.');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }
    function formatBRL(n) {
      return (Number(n) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderSummaryFromTable() {
      const tbody = document.querySelector('#entries-sheet tbody');
      if (!tbody) return;

      let totalIncome = 0;
      let totalExpense = 0;
      let totalInvest = 0;

      // Colunas: 0 Data | 1 Categoria | 2 Descrição | 3 Entrada | 4 Saída | 5 Saldo | 6 Ações
      tbody.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 5) return;

        const category = (tds[1]?.textContent || '').trim();
        const income   = parseBRL(tds[3]?.textContent || '');
        const expense  = parseBRL(tds[4]?.textContent || '');

        totalIncome  += income;
        totalExpense += expense;

        // Regra simples: toda linha com categoria "Investimento" soma em investimento
        if (/^investimento$/i.test(category)) {
          totalInvest += income > 0 ? income : expense;
        }
      });

      const profit = totalIncome - totalExpense;

      // Atualiza UI
      const elIncome  = document.getElementById('sum-income');
      const elExpense = document.getElementById('sum-expense');
      const elProfit  = document.getElementById('sum-profit');
      const elInvest  = document.getElementById('sum-invest');

      if (elIncome)  elIncome.textContent  = formatBRL(totalIncome);
      if (elExpense) elExpense.textContent = formatBRL(totalExpense);
      if (elInvest)  elInvest.textContent  = formatBRL(totalInvest);

      if (elProfit) {
        elProfit.textContent = formatBRL(profit);
        elProfit.classList.toggle('text-danger', profit < 0);
        elProfit.classList.toggle('text-success', profit >= 0);
      }
    }

    if (openSummary && summarybox) {
      openSummary.addEventListener('click', () => {
        renderSummaryFromTable();
        openModal(summarybox);
      });
    }
    if (closeSummary && summarybox)  closeSummary.addEventListener('click', () => closeModal(summarybox));
    if (closeSummary2 && summarybox) closeSummary2.addEventListener('click', () => closeModal(summarybox));
    if (summarybox) summarybox.addEventListener('click', (e) => { if (e.target === summarybox) closeModal(summarybox); });

    // ----- Modal "Editar"
    const editbox   = document.getElementById("editbox");
    const closeEdit = document.getElementById("close-editbox");
    const formEdit  = document.getElementById("edit-entry-form");
    const btnSave   = document.getElementById("edit-save");

    const inDate       = document.getElementById("edit_date");
    const inCategory   = document.getElementById("edit_category");
    const inDesc       = document.getElementById("edit_description");
    const inAmountMask = document.getElementById("edit_amount_mask");
    const inAmountReal = document.getElementById("edit-amount-real");
    const inId         = document.getElementById("edit-id");

    if (closeEdit && editbox) closeEdit.addEventListener("click", () => closeModal(editbox));
    if (editbox) editbox.addEventListener("click", (e) => { if (e.target === editbox) closeModal(editbox); });

    // Máscara: EDITAR
    attachMoneyMask(inAmountMask, inAmountReal);

    // Abrir modal com dados do lápis
    document.querySelectorAll(".js-edit-entry").forEach(btn => {
      btn.addEventListener("click", () => {
        const id          = btn.dataset.id;
        const date        = btn.dataset.date || "";
        const category    = btn.dataset.category || "";
        const description = btn.dataset.description || "";
        const amount      = btn.dataset.amount || "0.00"; // ponto + 2 casas

        if (inId)        inId.value = id;
        if (inDate)      inDate.value = date;
        if (inCategory)  inCategory.value = category;
        if (inDesc)      inDesc.value = description;

        if (formEdit) formEdit.dataset.updateUrl = `/entries/${id}`;

        if (inAmountMask && inAmountMask.__setFromDecimal) {
          inAmountMask.__setFromDecimal(amount); // preenche visual com vírgula
        }
        if (inAmountReal) inAmountReal.value = amount;        // hidden com ponto

        if (editbox) openModal(editbox);
      });
    });

    // Salvar edição via fetch PATCH
    let saving = false;
    if (btnSave && formEdit) {
      btnSave.addEventListener("click", async () => {
        if (saving) return; // Se ja estiver salvando sai
        saving = true; // Seta salvando para nao receber outro pedido durante execução
        setBusyButton(btnSave); // <<< desativa, escurece e pisca

        // Garante sync da máscara -> hidden
        if (inAmountMask && inAmountReal) {
          // "1.234,56" -> "1234.56"
          inAmountReal.value = inAmountMask.value.replace(/\./g, "").replace(",", ".");
        }

        const url = formEdit.dataset.updateUrl;
        if (!url) { alert("ID do lançamento não encontrado."); return; }

        const body = new URLSearchParams(new FormData(formEdit));

        try {
          const resp = await fetch(url, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
              ...(getCsrf() ? {"X-CSRF-Token": getCsrf()} : {})
            },
            body: body.toString()
          });

          if ([200, 204, 302].includes(resp.status)) {
            if (editbox) closeModal(editbox);
            window.location.assign("/entries");
          } else {
            console.error("PATCH falhou:", await resp.text());
            alert("Falha ao salvar. Verifique os campos.");
          }
        } catch (err) {
          console.error(err);
          alert("Erro de rede ao salvar.");
        } finally {
          clearBusyButton(btnSave); // Reabilitar botão apos execusão caso não tenha tido redirect
          saving = false;
        }
      });
    }
  })();
</script>
